<h3 class="page-header">技师列表</h3>

<%
  def mechanic_state_link_to state, text
    link = link_to text, merchants_mechanics_path(state: state)
    class_name = (@state == state) ? "active" : ""
    %{<li class="#{class_name}">#{link}</li>}.html_safe
  end
%>

<div class="row">
  <div class="col-md-2 col-xs-4">
    <ul class="nav nav-pills nav-stacked">
      <%= mechanic_state_link_to nil, "查询技师" %>
      <%= mechanic_state_link_to :followeds, "我的技师" %>
    </ul>
  </div>

  <% case @state %>
  <% when :followeds %>
    <% @mechanics = current_store.followed_mechanics.shown %>

    <form class="form-inline" id="mechanics_form">
      <label class="mr20" id="mechanics_skills">类型： <%= select_tag "skills", "<option value=\"\">全部</option>".html_safe + options_from_collection_for_select(Skill.all, :name, :name), class: "form-control", id: "mechanics_skills_select" %></label>
    </form>

  <% else %>

    <% province_cd = (params[:province] || Province.first.id).to_i %>

    <form class="form-inline" id="mechanics_form">
      <label>省份： <%= select_tag "province", options_from_collection_for_select(Province.all, :id, :name, province_cd), class: "form-control", id: "mechanics_provinces_select" %></label>
      <label class="mr20" id="mechanics_skills">类型： <%= select_tag "skills", "<option value=\"\">全部</option>".html_safe + options_from_collection_for_select(Skill.all, :name, :name, params[:skills]), class: "form-control", id: "mechanics_skills_select" %></label>
    </form>

    <% @followed_mechanic_ids = current_store.followed_mechanic_ids %>
    <% @mechanics = Mechanic.shown %>
    <% @mechanics = @mechanics.where(province_cd: province_cd) %>

  <% end %>

  <div class="col-md-10 col-xs-8">

    <%= index_for [ :merchants, @mechanics ], class: "table table-hover" do |i| %>

      <%= i.attribute :skills do |mechanic| %>
        <%= mechanic.skills.join("、") %>
      <% end %>

      <%= i.attribute :user_nickname %>
      <%= i.attribute :user_mobile %>
      <%= i.attribute :unique_id %>

      <%= i.attribute :province %>
      <%= i.attribute :city %>
      <%= i.attribute :district %>

      <%= i.attribute :available_orders_count %>
      <%= i.attribute :revoke_orders_count %>
      <%= i.attribute :professionality_average %>
      <%= i.attribute :timeliness_average %>

      <%= i.actions :show do |a| %>
        <% if @state == :followeds || @followed_mechanic_ids.include?(i.object.id) %>
          <%= a.action_link :unfollow, method: :post, confirm: "你确定要取消关注？" %>
        <% else %>
          <%= a.action_link :follow, method: :post %>
        <% end %>
      <% end %>
    <% end %>
  </div>
</div>

<script type="text/javascript">
  (function() {
    var dataTable = $("#mechanics").DataTable({
      order: [], // Do not sort by default
      pagingType: 'full_numbers',
      dom: "<'row'<'col-sm-3'l><'col-sm-9'f>><'row'<'col-sm-12'tr>><'row'<'col-sm-5'i><'col-sm-7'p>>",
      language: {
        lengthMenu: "每页显示 _MENU_ 条记录",
        info: "从 _START_ 到 _END_ /共 _TOTAL_ 条数据",
        infoEmpty: "没有数据",
        infoFiltered: "(从 _MAX_ 条数据中检索)",
        zeroRecords: "没有检索到数据",
        search: "搜索：",
        paginate: {
          first: "首页",
          previous: "前一页",
          next: "后一页",
          last: "尾页"
        }
      }
    });

    var skillColumn = dataTable.column(0);
    skillColumn.visible(false);

    $form = $("#mechanics_form");
    $form.prependTo($("#mechanics_filter"));

    $("#mechanics_skills_select").change(function() {
      skillColumn.search($(this).val());
      dataTable.draw();
    }).trigger('change');

    <% unless @state %>

      var $province = $("#mechanics_provinces_select");
      $province.change(function() {
        if ($province.val()) $form.submit();
      });

    <% end %>

  })();
</script>
