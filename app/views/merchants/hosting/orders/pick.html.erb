<h3 class="page-header"><%= @order.assigned? ? "改派技师" : "指派技师" %></h3>

<%= bootstrap_simple_form_for([ :merchants, :hosting, @order ], url: pick_merchants_hosting_order_path(@order)) do |f| %>
  <div class="row">
    <div class="col-md-12" id="mechanic_list">
      <%= f.error_messages %>

      <label class="mr20" id="mechanics_skills">类型： <%= select_tag "skills", "<option value=\"\">全部</option>".html_safe + options_from_collection_for_select(Skill.all, :name, :name), class: "form-control", id: "mechanics_skills_select" %></label>

      <% @followed_mechanic_ids = current_store.followed_mechanic_ids %>
      <% @mechanics = Mechanic.includes(:user, :skills) %>
      <% @mechanics = @mechanics.where(province_cd: @order.province_cd) %>
      <% @mechanics = @mechanics.shown %>
      <%= index_for [ :merchants, @mechanics ], class: "table table-hover" do |i| %>
        <%= i.attribute :_check do |mechanic| %>
          <%= f.radio_button :mechanic_id, mechanic.id %>
        <% end %>

        <%= i.attribute :skills do |mechanic| %>
          <%= mechanic.skills.join("、") %>
        <% end %>

        <%= i.attribute :user_nickname %>
        <%= i.attribute :user_mobile %>
        <%= i.attribute :unique_id %>

        <%= i.attribute :province %>
        <%= i.attribute :city %>
        <%= i.attribute :district %>

        <%= i.attribute :available_orders_count %>
        <%= i.attribute :revoke_orders_count %>
        <%= i.attribute :professionality_average %>
        <%= i.attribute :timeliness_average %>

        <%= i.actions :show do |a| %>
          <% if @followed_mechanic_ids.include? i.object.id %>
            <%= a.action_link :unfollow, method: :post, confirm: "你确定要取消关注？" %>
          <% else %>
            <%= a.action_link :follow, method: :post %>
          <% end %>
        <% end %>

      <% end %>
    </div>

    <div class="col-md-12 map" id="map"></div>

    <div class="col-md-7">
      <%= f.input :remark, hint: "备注对所有人可见", input_html: { rows: 4 } %>
    </div>

    <div class="col-md-12">
      <%= f.button :submit, "确定", class: "btn-primary pull-right" %>
    </div>
  </div>
<% end %>

<script charset="utf-8" src="http://map.qq.com/api/js?v=2.exp"></script>
<script type="text/javascript">
  (function() {
    var dataTable = $("#mechanics").DataTable({
      order: [], // Do not sort by default
      pagingType: 'full_numbers'
    });

    var skillColumn = dataTable.column(1);
    skillColumn.visible(false);

    $("#mechanics_skills").prependTo($("#mechanics_filter"));
    $("#mechanics_skills_select").change(function() {
      skillColumn.search($(this).val());
      dataTable.draw();
    });

    $("#mechanic_list input[checked]").trigger("click");

    // initialze map
    var map = new qq.maps.Map($('#map')[0], {
      zoom: 12
    });

    var imageBlue = <%= raw image_path("map-marker-blue.png").to_json %>,
        imageRed = <%= raw image_path("map-marker-red.png").to_json %>,
        size = new qq.maps.Size(256, 256),
        origin = new qq.maps.Point(0, 0),
        anchor = new qq.maps.Point(16, 32),
        scaleSize = new qq.maps.Size(32, 32),
        iconBlue = new qq.maps.MarkerImage(imageBlue, size, origin, anchor, scaleSize),
        iconRed = new qq.maps.MarkerImage(imageRed, size, origin, anchor, scaleSize);

    function setMarkerByPosition(position, icon) {
      return new qq.maps.Marker({
        icon: icon,
        map: map,
        position: position
      });
    }

    function setMarker(record, icon) {
      if (!record.lat || !record.lng) {
        var geocoder = new qq.maps.Geocoder({
          complete: function(result) {
            map.setCenter(result.detail.location);
            setMarkerByPosition(result.detail.location, icon);
          }
        });
        geocoder.getLocation(record.address);
      } else {
        setMarkerByPosition(new qq.maps.LatLng(record.lat, record.lng), icon);
      }
    }

    setMarker(<%= raw @order.to_json(only: %w(lat lng address)) %>, iconRed);

    var mechanics = <%= raw @mechanics.map { |mechanic| mechanic.user.as_json(only: %w(lat lng address)) }.to_json %>;

    $.each(mechanics, function(index, mechanic) {
      setMarker(mechanic, iconBlue);
    });

  })();
</script>
