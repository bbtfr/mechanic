<%= content_for :title do %>
  我的信息
<% end %>

<%
city_map = City.all.to_a.
  group_by(&:province_id).
  map {|key, value|[key, value.map {|obj| [ obj.name, obj.id ]}]}.
  to_h
district_map = District.all.to_a.
  group_by(&:city_id).
  map {|key, value|[key, value.map {|obj| [ obj.name, obj.id ]}]}.
  to_h
%>

<%= simple_form_for(@user, url: user_path) do |f| %>
  <%= f.error_messages %>
  <%= f.hidden_field :mobile_confirmed, value: true %>

  <div class="jumbotron vertical-parent">
    <div class="text-center vertical-middle">
      <div class="input image">
        <%= f.input_field :avatar, accept: "image/*" %>
        <img src="http://placehold.it/100x100" alt="" class="img-circle" id="user_avatar_preview">
      </div>
    </div>
  </div>

  <div class="content-padded">
    <%= f.input :nickname %>
    <%= f.input :gender, collection: enum_option_pairs(User, :gender) %>
    <%= f.input :address %>

    <% if @user.is_mechanic %>
      <%= f.input :skill_ids, as: :check_boxes, collection: Skill.all %>

      <%= f.input :province_id, collection: Province.all %>
      <%= f.input :city_id, collection: city_map[@user.province_id] || [] %>
      <%= f.input :district_id, collection: district_map[@user.city_id] || [] %>

      <%= f.input :description, as: :text, input_html: { rows: 4 } %>
    <% end %>

    <%= f.button :submit, "确定", class: "btn-block btn-positive" %>
  </div>
<% end %>

<script type="text/javascript">
  var cityMap = <%= raw city_map.to_json %>
  var districtMap = <%= raw district_map.to_json %>

  var province = user_province_id;
  var city = user_city_id;
  var district = user_district_id;

  var provinceCallback = function() {
    removeOptions(city.querySelectorAll("option"));
    removeOptions(district.querySelectorAll("option"));
    appendOptions(city, cityMap[province.value]);
  };

  var cityCallback = function() {
    removeOptions(district.querySelectorAll("option"));
    appendOptions(district, districtMap[city.value]);
  };

  province.addEventListener("change", provinceCallback);
  city.addEventListener("change", cityCallback);

  var input = user_avatar;
  var preview = user_avatar_preview;

  input.addEventListener("change", function() {
    URL = window.URL || window.webkitURL;
    var src = URL.createObjectURL(input.files[0]);
    preview.src = src;
  }, false);
</script>
